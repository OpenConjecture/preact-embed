{"version":3,"sources":["../src/index.ts"],"names":["camelCase","str","_","letter","getCurrentScript","scripts","safeJsonParse","json","fallback","getPropsFromAttributes","element","props","attrs","i","attr","propName","value","parsed","getPropsFromScripts","script","content","collectProps","defaultProps","attrProps","scriptProps","findHostElements","options","selector","inline","clientSpecified","elements","mountIn","el","HABITAT_KEY","setHabitatMeta","meta","getHabitatMeta","clearHabitatMeta","habitat","Widget","instances","globalOptions","renderOne","overrideProps","existingMeta","modified","child","root","shadowInit","vnode","h","renderFn","hydrate","render","doRender","observerOptions","observer","entries","entry","unmount","idx","update","newProps","instance","renderAll","registerCustomElement","newInstances","unmountAll","tagName","PreactHabitatElement","target","HabitatEventBus","event","callback","args","error","eventBus","useHabitatEvent","initialValue","setValue","useState","useEffect","data","emit","useCallback","newValue","mount","autoMount","doMount","src_default"],"mappings":"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","file":"index.cjs","sourcesContent":["/**\n * Preact Habitat Modern\n * A lightweight (~1KB) framework for embedding Preact micro-components in any DOM.\n *\n * Features:\n * - TypeScript-first with full type safety\n * - Shadow DOM support for style isolation\n * - Intersection Observer for lazy loading\n * - Custom Elements integration\n * - Event-based communication between widgets\n * - SSR hydration support\n * - Cleanup/unmount capabilities\n */\n\nimport { h, render, hydrate, ComponentType, VNode } from 'preact';\n\n// ============================================================================\n// Types\n// ============================================================================\n\nexport interface HabitatOptions<P extends object = {}> {\n  /** CSS selector to find mount points */\n  selector?: string;\n  /** Default props for all widget instances */\n  defaultProps?: Partial<P>;\n  /** Mount in the parent node of the script tag (inline mode) */\n  inline?: boolean;\n  /** Remove innerHTML before mounting */\n  clean?: boolean;\n  /** Allow script tag to specify mount target via data-mount-in attribute */\n  clientSpecified?: boolean;\n  /** Enable Shadow DOM for style isolation */\n  shadowRoot?: boolean | ShadowRootInit;\n  /** Lazy load using Intersection Observer */\n  lazy?: boolean | IntersectionObserverInit;\n  /** Hydrate instead of render (for SSR) */\n  hydrate?: boolean;\n  /** Custom element tag name (registers as Web Component) */\n  tagName?: string;\n  /** Called before each widget mounts */\n  onBeforeMount?: (element: Element, props: P) => void | P;\n  /** Called after each widget mounts */\n  onMounted?: (element: Element, props: P) => void;\n  /** Called when widget unmounts */\n  onUnmount?: (element: Element) => void;\n}\n\nexport interface WidgetInstance<P extends object = {}> {\n  element: Element;\n  props: P;\n  unmount: () => void;\n  update: (newProps: Partial<P>) => void;\n}\n\nexport interface HabitatResult<P extends object = {}> {\n  render: (options?: HabitatOptions<P>) => WidgetInstance<P>[];\n  renderOne: (element: Element, props?: Partial<P>) => WidgetInstance<P>;\n  unmountAll: () => void;\n  instances: WidgetInstance<P>[];\n}\n\n// ============================================================================\n// Utilities\n// ============================================================================\n\n/**\n * Convert kebab-case to camelCase\n * data-prop-hello-world => helloWorld\n */\nfunction camelCase(str: string): string {\n  return str.replace(/-([a-z])/gi, (_, letter) => letter.toUpperCase());\n}\n\n/**\n * Get the currently executing script element\n */\nfunction getCurrentScript(): HTMLScriptElement | null {\n  if (document.currentScript) {\n    return document.currentScript as HTMLScriptElement;\n  }\n  // Fallback for older browsers\n  const scripts = document.getElementsByTagName('script');\n  return scripts[scripts.length - 1] as HTMLScriptElement;\n}\n\n/**\n * Parse JSON safely with error handling\n */\nfunction safeJsonParse<T>(json: string, fallback: T): T {\n  try {\n    return JSON.parse(json);\n  } catch {\n    console.warn('[preact-habitat] Failed to parse JSON props:', json);\n    return fallback;\n  }\n}\n\n/**\n * Collect props from element's data-prop-* attributes\n */\nfunction getPropsFromAttributes(element: Element): Record<string, unknown> {\n  const props: Record<string, unknown> = {};\n  const attrs = element.attributes;\n\n  for (let i = 0; i < attrs.length; i++) {\n    const attr = attrs[i];\n    if (attr.name.startsWith('data-prop-')) {\n      const propName = camelCase(attr.name.slice(10)); // Remove 'data-prop-'\n      let value: unknown = attr.value;\n\n      // Try to parse as JSON for objects/arrays/booleans/numbers\n      if (value === 'true') value = true;\n      else if (value === 'false') value = false;\n      else if (value === 'null') value = null;\n      else if (!isNaN(Number(value)) && value !== '') value = Number(value);\n      else {\n        try {\n          const parsed = JSON.parse(value as string);\n          if (typeof parsed === 'object') value = parsed;\n        } catch {\n          // Keep as string\n        }\n      }\n\n      props[propName] = value;\n    }\n  }\n\n  return props;\n}\n\n/**\n * Collect props from script tags inside element\n */\nfunction getPropsFromScripts(element: Element): Record<string, unknown> {\n  const scripts = element.querySelectorAll(\n    'script[type=\"application/json\"], script[type=\"text/props\"]'\n  );\n\n  let props: Record<string, unknown> = {};\n\n  scripts.forEach((script) => {\n    const content = script.innerHTML.trim();\n    if (content) {\n      const parsed = safeJsonParse(content, {});\n      props = { ...props, ...parsed };\n    }\n  });\n\n  return props;\n}\n\n/**\n * Collect all props for an element\n */\nfunction collectProps<P extends object>(\n  element: Element,\n  defaultProps?: Partial<P>\n): P {\n  const attrProps = getPropsFromAttributes(element);\n  const scriptProps = getPropsFromScripts(element);\n\n  return {\n    ...defaultProps,\n    ...scriptProps,\n    ...attrProps,\n  } as P;\n}\n\n/**\n * Find all host elements based on options\n */\nfunction findHostElements<P extends object = {}>(options: HabitatOptions<P>): Element[] {\n  const { selector, inline, clientSpecified } = options;\n  const elements: Element[] = [];\n\n  if (inline) {\n    const script = getCurrentScript();\n    if (script?.parentElement) {\n      elements.push(script.parentElement);\n    }\n  } else if (clientSpecified) {\n    const script = getCurrentScript();\n    const mountIn = script?.getAttribute('data-mount-in');\n    if (mountIn) {\n      const found = document.querySelectorAll(mountIn);\n      found.forEach((el) => elements.push(el));\n    }\n  } else if (selector) {\n    const found = document.querySelectorAll(selector);\n    found.forEach((el) => elements.push(el));\n  }\n\n  return elements;\n}\n\n// ============================================================================\n// Widget Storage (for tracking mounted instances)\n// ============================================================================\n\nconst HABITAT_KEY = Symbol('preact-habitat');\n\ninterface HabitatMeta {\n  root: Element | ShadowRoot;\n  vnode: VNode<{}> | null;\n  unmount: () => void;\n}\n\nfunction setHabitatMeta(element: Element, meta: HabitatMeta): void {\n  (element as any)[HABITAT_KEY] = meta;\n}\n\nfunction getHabitatMeta(element: Element): HabitatMeta | undefined {\n  return (element as any)[HABITAT_KEY];\n}\n\nfunction clearHabitatMeta(element: Element): void {\n  delete (element as any)[HABITAT_KEY];\n}\n\n// ============================================================================\n// Core Habitat Factory\n// ============================================================================\n\n/**\n * Create a habitat for a Preact component\n */\nexport function habitat<P extends object = {}>(\n  Widget: ComponentType<P>\n): HabitatResult<P> {\n  const instances: WidgetInstance<P>[] = [];\n  let globalOptions: HabitatOptions<P> = {};\n\n  /**\n   * Render a single widget instance\n   */\n  function renderOne(\n    element: Element,\n    overrideProps?: Partial<P>\n  ): WidgetInstance<P> {\n    // Check if already mounted\n    const existingMeta = getHabitatMeta(element);\n    if (existingMeta) {\n      console.warn('[preact-habitat] Element already has a mounted widget');\n      existingMeta.unmount();\n    }\n\n    // Collect props\n    let props = collectProps<P>(element, {\n      ...globalOptions.defaultProps,\n      ...overrideProps,\n    });\n\n    // Call onBeforeMount hook\n    if (globalOptions.onBeforeMount) {\n      const modified = globalOptions.onBeforeMount(element, props);\n      if (modified) props = modified;\n    }\n\n    // Clean if requested\n    if (globalOptions.clean) {\n      // Remove all children except script tags with props\n      const children = Array.from(element.childNodes);\n      children.forEach((child) => {\n        if (\n          child.nodeType === Node.ELEMENT_NODE &&\n          (child as Element).tagName === 'SCRIPT' &&\n          ((child as Element).getAttribute('type') === 'application/json' ||\n            (child as Element).getAttribute('type') === 'text/props')\n        ) {\n          return; // Keep prop scripts\n        }\n        child.parentNode?.removeChild(child);\n      });\n    }\n\n    // Determine render root (regular or shadow)\n    let root: Element | ShadowRoot = element;\n    if (globalOptions.shadowRoot) {\n      const shadowInit: ShadowRootInit =\n        typeof globalOptions.shadowRoot === 'object'\n          ? globalOptions.shadowRoot\n          : { mode: 'open' };\n      root = element.attachShadow(shadowInit);\n    }\n\n    // Create the widget VNode\n    const vnode = h(Widget, props as any);\n\n    // Render or hydrate\n    const renderFn = globalOptions.hydrate ? hydrate : render;\n\n    // Perform the render\n    const doRender = () => {\n      renderFn(vnode, root as Element);\n    };\n\n    // Handle lazy loading\n    if (globalOptions.lazy) {\n      const observerOptions: IntersectionObserverInit =\n        typeof globalOptions.lazy === 'object' ? globalOptions.lazy : {};\n\n      const observer = new IntersectionObserver((entries) => {\n        entries.forEach((entry) => {\n          if (entry.isIntersecting) {\n            doRender();\n            observer.disconnect();\n          }\n        });\n      }, observerOptions);\n\n      observer.observe(element);\n    } else {\n      doRender();\n    }\n\n    // Create unmount function\n    const unmount = () => {\n      render(null, root as Element);\n      clearHabitatMeta(element);\n      globalOptions.onUnmount?.(element);\n\n      // Remove from instances array\n      const idx = instances.findIndex((i) => i.element === element);\n      if (idx > -1) instances.splice(idx, 1);\n    };\n\n    // Create update function\n    const update = (newProps: Partial<P>) => {\n      props = { ...props, ...newProps };\n      render(h(Widget, props as any), root as Element);\n    };\n\n    // Store metadata\n    setHabitatMeta(element, { root, vnode: vnode as VNode<{}>, unmount });\n\n    // Create instance\n    const instance: WidgetInstance<P> = {\n      element,\n      props,\n      unmount,\n      update,\n    };\n\n    instances.push(instance);\n\n    // Call onMounted hook\n    globalOptions.onMounted?.(element, props);\n\n    return instance;\n  }\n\n  /**\n   * Render widgets to all matching elements\n   */\n  function renderAll(options: HabitatOptions<P> = {}): WidgetInstance<P>[] {\n    globalOptions = options;\n\n    // Handle custom elements registration\n    if (options.tagName) {\n      registerCustomElement(options.tagName, Widget, options);\n      return instances;\n    }\n\n    const elements = findHostElements(options);\n    const newInstances: WidgetInstance<P>[] = [];\n\n    elements.forEach((element) => {\n      const instance = renderOne(element);\n      newInstances.push(instance);\n    });\n\n    return newInstances;\n  }\n\n  /**\n   * Unmount all widget instances\n   */\n  function unmountAll(): void {\n    [...instances].forEach((instance) => instance.unmount());\n  }\n\n  return {\n    render: renderAll,\n    renderOne,\n    unmountAll,\n    instances,\n  };\n}\n\n// ============================================================================\n// Custom Elements Integration\n// ============================================================================\n\n/**\n * Register a Preact component as a Custom Element\n */\nexport function registerCustomElement<P extends object>(\n  tagName: string,\n  Widget: ComponentType<P>,\n  options: HabitatOptions<P> = {}\n): void {\n  if (customElements.get(tagName)) {\n    console.warn(`[preact-habitat] Custom element \"${tagName}\" already registered`);\n    return;\n  }\n\n  class PreactHabitatElement extends HTMLElement {\n    private _props: P = {} as P;\n    private _root: ShadowRoot | null = null;\n    private _mounted = false;\n\n    static get observedAttributes(): string[] {\n      return []; // Can be customized\n    }\n\n    constructor() {\n      super();\n      if (options.shadowRoot !== false) {\n        const shadowInit: ShadowRootInit =\n          typeof options.shadowRoot === 'object'\n            ? options.shadowRoot\n            : { mode: 'open' };\n        this._root = this.attachShadow(shadowInit);\n      }\n    }\n\n    connectedCallback(): void {\n      this._props = collectProps<P>(this, options.defaultProps);\n      this._render();\n      this._mounted = true;\n    }\n\n    disconnectedCallback(): void {\n      if (this._mounted) {\n        const target = this._root || this;\n        render(null, target);\n        this._mounted = false;\n      }\n    }\n\n    attributeChangedCallback(): void {\n      if (this._mounted) {\n        this._props = collectProps<P>(this, options.defaultProps);\n        this._render();\n      }\n    }\n\n    private _render(): void {\n      const target = this._root || this;\n      render(h(Widget, this._props as any), target);\n    }\n\n    // Public API for programmatic updates\n    setProps(newProps: Partial<P>): void {\n      this._props = { ...this._props, ...newProps };\n      if (this._mounted) {\n        this._render();\n      }\n    }\n\n    getProps(): P {\n      return { ...this._props };\n    }\n  }\n\n  customElements.define(tagName, PreactHabitatElement);\n}\n\n// ============================================================================\n// Event Bus for Widget Communication\n// ============================================================================\n\ntype EventCallback = (...args: unknown[]) => void;\n\nclass HabitatEventBus {\n  private events: Map<string, Set<EventCallback>> = new Map();\n\n  on(event: string, callback: EventCallback): () => void {\n    if (!this.events.has(event)) {\n      this.events.set(event, new Set());\n    }\n    this.events.get(event)!.add(callback);\n\n    // Return unsubscribe function\n    return () => this.off(event, callback);\n  }\n\n  off(event: string, callback: EventCallback): void {\n    this.events.get(event)?.delete(callback);\n  }\n\n  emit(event: string, ...args: unknown[]): void {\n    this.events.get(event)?.forEach((callback) => {\n      try {\n        callback(...args);\n      } catch (error) {\n        console.error(`[preact-habitat] Error in event handler for \"${event}\":`, error);\n      }\n    });\n  }\n\n  clear(): void {\n    this.events.clear();\n  }\n}\n\nexport const eventBus = new HabitatEventBus();\n\n// ============================================================================\n// React Hook for Event Bus\n// ============================================================================\n\nimport { useEffect, useState, useCallback } from 'preact/hooks';\n\n/**\n * Hook to subscribe to habitat events\n */\nexport function useHabitatEvent<T = unknown>(\n  event: string,\n  initialValue?: T\n): [T | undefined, (value: T) => void] {\n  const [value, setValue] = useState<T | undefined>(initialValue);\n\n  useEffect(() => {\n    const unsubscribe = eventBus.on(event, (data) => {\n      setValue(data as T);\n    });\n    return unsubscribe;\n  }, [event]);\n\n  const emit = useCallback(\n    (newValue: T) => {\n      eventBus.emit(event, newValue);\n    },\n    [event]\n  );\n\n  return [value, emit];\n}\n\n// ============================================================================\n// Utility Exports\n// ============================================================================\n\nexport { h, render, hydrate } from 'preact';\nexport { useState, useEffect, useCallback, useMemo, useRef } from 'preact/hooks';\n\n/**\n * Helper to create a habitat and immediately render\n */\nexport function mount<P extends object = {}>(\n  Widget: ComponentType<P>,\n  options: HabitatOptions<P> = {}\n): WidgetInstance<P>[] {\n  const { render } = habitat(Widget);\n  return render(options);\n}\n\n/**\n * Auto-mount when DOM is ready\n */\nexport function autoMount<P extends object = {}>(\n  Widget: ComponentType<P>,\n  options: HabitatOptions<P> = {}\n): void {\n  const doMount = () => mount(Widget, options);\n\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', doMount);\n  } else {\n    doMount();\n  }\n}\n\n// Default export\nexport default habitat;\n"]}